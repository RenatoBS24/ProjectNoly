<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Notificaciones</title>
    <link rel="stylesheet" th:href="@{/css/styleSidebar.css}">
    <link rel="stylesheet" th:href="@{/css/styleLogOut.css}">
    <link rel="stylesheet" th:href="@{/css/styleNotification.css}">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link rel="stylesheet" href="../static/css/styleNotification.css">
    <link rel="shortcut icon" th:href="@{/img/logo.ico}" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div th:replace="~{fragments :: sidebar}"></div>
<div class="main">
    <div class="notifications-container">
        <div class="notifications-header">
            <h1 class="notifications-title">Notificaciones</h1>
            <div class="notifications-actions">
                <button class="action-button" onclick="markAllAsRead()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M10.067 6.76 7.5 9.326 5.933 7.76a.75.75 0 1 0-1.066 1.06l2.5 2.5a.75.75 0 0 0 1.066 0l3.5-3.5a.75.75 0 0 0-1.066-1.06z"/>
                    </svg>
                    Marcar todas como le√≠das
                </button>
                <button class="action-button secondary" onclick="deleteAllRead()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1z"/>
                    </svg>
                    Limpiar le√≠das
                </button>
            </div>
        </div>
        <div class="notifications-filters">
            <div class="filter-tab active" onclick="filterNotifications('all')" data-filter="all">
                Todas (<span id="count-all">5</span>)
            </div>
            <div class="filter-tab" onclick="filterNotifications('unread')" data-filter="unread">
                No le√≠das (<span id="count-unread">3</span>)
            </div>
            <div class="filter-tab" onclick="filterNotifications('critical')" data-filter="critical">
                Cr√≠ticas (<span id="count-critical">1</span>)
            </div>
            <div class="filter-tab" onclick="filterNotifications('stock')" data-filter="stock">
                Stock (<span id="count-stock">2</span>)
            </div>
        </div>
        <div class="notifications-list" id="notificationsList">
            <div th:each="notification: ${notifications}"   th:class="'notification-item ' + (${notification.isRead} ? 'read' : 'unread') + (${notification.isCritical} ? ' critical' : '')" data-type="critical stock" data-id="1">
                <div class="notification-icon" th:classappend="${notification.isCritical} ? ' critical' : ' stock'">
                    <svg th:if="${notification.isCritical}" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/>
                        <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
                    </svg>
                    <svg th:if="${!notification.isCritical}" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.93 6.588l-4.39 4.39a.75.75 0 0 1-1.06 0l-2.39-2.39a.75.75 0 1 1 1.06-1.06l1.86 1.86 3.86-3.86a.75.75 0 1 1 1.06 1.06z"/>
                    </svg>
                </div>
                <div class="notification-content">
                    <div class="notification-title" th:text="${notification.isCritical} ? '¬°STOCK CR√çTICO!' : 'Stock bajo detectado'"></div>
                    <div class="notification-message" th:text="${notification.message}"></div>
                    <div class="notification-time" th:text="${notification.elapsedTime}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71z"/>
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0"/>
                        </svg>
                    </div>
                </div>
                <div class="notification-actions">
                    <button th:if="${!notification.isRead}" class="notification-btn mark-read" onclick="markAsRead(1)">Marcar le√≠da</button>
                    <button class="notification-btn delete" onclick="deleteNotification(1)">Eliminar</button>
                </div>
            </div>
        </div>

        </div><div class="empty-notifications" id="emptyState" th:style="${#lists.isEmpty(notifications)} ? 'display: block;' : 'display: none;'">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2M8 1.918l-.797.161A4 4 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4 4 0 0 0-3.203-3.92zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5 5 0 0 1 13 6c0 .88.32 4.2 1.22 6"/>
            </svg>
            <h3>No hay notificaciones</h3>
            <p>Cuando tengas nuevas notificaciones aparecer√°n aqu√≠.</p>
        </div>
</div>
<div th:replace="~{fragments :: LogOutModal}"></div>
<script>
    console.log("Iniciando worker de notificaciones...");
    const worker = new SharedWorker('/js/webSocketNotification.js');
    worker.port.onmessage = (event) => {
        console.log("üîî Notificaci√≥n recibida en vista:", event.data);
        showNotification(event.data);
    };
    worker.port.start();
    console.log("Worker de notificaciones iniciado.");
    worker.port.postMessage("start");
</script>
<script th:src="@{/js/LogOut.js}"></script>
<script th:src="@{/js/sidebar.js}"></script>
</body>
</html>